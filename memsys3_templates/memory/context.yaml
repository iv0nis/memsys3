# Context Template
# Este es el archivo que carga DevAI para entender el proyecto
# Es compilado por el Context Agent (CA) desde memory/full/
# Límite ÚNICO: máximo 2000 líneas total

metadata:
  compilado_por: "Context Agent"
  ultima_compilacion: "2025-10-31"
  version_context: "1.5"

# ============================================
# INFORMACIÓN DEL PROYECTO
# ============================================
project:
  nombre: "memsys3"
  descripcion: "Sistema de gestión de contexto para AI Development Agents"
  fase: "Development v1.3"
  ultima_feature: "Sistema preparado para deployment: viz/ en raíz, history/ creado, deploy.md con ADR-009, 9 bugs críticos corregidos"
  siguiente_milestone: "Testing deployment real en proyecto UOC"

# ============================================
# FEATURES OPERATIVAS
# ============================================
features:
  context_agent:
    nombre: "Context Agent"
    estado: "operativo"
    descripcion: "Agente que compila contexto completo con criterio inteligente (máx 2000 líneas)"

  rotacion_automatica:
    nombre: "Rotación Automática"
    estado: "operativo"
    descripcion: "Sistema de rotación sessions/ADRs cuando superan 1800 líneas"

  plan_contingencia:
    nombre: "Plan de Contingencia"
    estado: "operativo"
    descripcion: "Archivado inteligente a history/ cuando >150K tokens"

  visualizador:
    nombre: "Memory Visualizer"
    estado: "operativo"
    descripcion: "Dashboard web para ver la 'mente' de los agentes (4 pestañas) - Ubicado en memsys3/viz/"

  prompts:
    nombre: "Prompts Reutilizables"
    estado: "operativo"
    descripcion: "newSession, endSession, compile-context, mind, deploy - TODOS con rutas @memsys3/"

  documentacion:
    nombre: "Sistema de Documentación Multi-nivel"
    estado: "operativo"
    descripcion: "4 niveles: README repo, README templates, DEVELOPMENT, UPDATE"

# ============================================
# STACK TECNOLÓGICO
# ============================================
stack:
  frontend: "HTML/CSS/JS (visualizador)"
  backend: "Python 3.x (servidor visualizador)"
  database: "Ninguna (YAML files)"
  deploy: "GitHub + clonado local"
  lenguaje_docs: "YAML + Markdown"

# ============================================
# URLS PRINCIPALES
# ============================================
urls:
  repository: "https://github.com/iv0nis/memsys3"

# ============================================
# ADRs RELEVANTES
# Todas las ADRs son críticas para entender el sistema
# ============================================
adrs:
  - id: "009"
    titulo: "Templates como documentación activa permanente + gotchas en sessions"
    decision: |
      **1. Concepto de memsys3_templates/ (ms3t):**
      - ms3t/ = Estructura EXACTA del producto final
      - Todos los archivos se copian durante deployment (incluido memory/templates/)
      - memory/templates/ NO se borra después del deployment

      **2. memory/templates/ = Guías permanentes:**
      - Main-Agent consulta templates/ durante endSession.md
      - Templates son documentación ACTIVA, no solo guías de deployment

      **3. Gotchas documentados en sessions.yaml:**
      - Main-Agent documenta gotchas en cada sesión donde aparecen con criticidad
      - Context-Agent extrae gotchas de TODAS las sesiones
      - CA usa criterio inteligente para seleccionar top 5 más críticos
      - project-status.yaml NO contiene gotchas (solo info general del proyecto)

      **4. Workflow de deployment actualizado:**
      1. git clone https://github.com/iv0nis/memsys3 memsys3_temp
      2. cp -r memsys3_temp/memsys3/* ./memsys3/
      3. Briefing usando templates/ como guía
      4. Rellenar campos vacíos en project-status.yaml, main-agent.yaml
      5. rm -rf memsys3_temp/
    impacto: "Deployment más simple. Main-Agent siempre tiene referencia. Gotchas contextualizados. CA tiene flexibilidad para priorizar gotchas."

  - id: "006"
    titulo: "Sistema de rutas unificado memsys3/"
    decision: |
      TODAS las rutas en memsys3_templates/ deben usar el prefijo memsys3/ (notación: @memsys3/).
      Durante deployment, memsys3_templates/ se copia a la raíz del proyecto como memsys3/.
    impacto: "Claridad total, portabilidad, sin conflictos con carpetas del proyecto."

  - id: "007"
    titulo: "Separación de meta-niveles en READMEs"
    decision: |
      4 READMEs separados: raíz (público), templates (sistema desplegado), DEVELOPMENT (contribución), UPDATE (actualización).
    impacto: "Claridad total de meta-niveles. Cada audiencia tiene README específico."

  - id: "008"
    titulo: "Main-Agent NO debe proponer compile-context"
    decision: |
      Main-Agent NO propone ejecutar compile-context.md (consume muchos tokens).
      compile-context.md se ejecuta en NUEVA INSTANCIA limpia.
    impacto: "Eficiencia de tokens optimizada. User controla cuándo compilar."

  - id: "001"
    titulo: "Criterio inteligente del Context Agent vs límites arbitrarios"
    decision: |
      El Context Agent usa criterio inteligente: "¿Qué debe saber CUALQUIER agente descontextualizado?"
      Límite ÚNICO: máximo 2000 líneas en el context.yaml final.
    impacto: "Contexto adaptativo según necesidades del proyecto."

  - id: "002"
    titulo: "Rotación automática de sessions/ADRs (>1800 líneas)"
    decision: |
      Cuando sessions.yaml o adr.yaml superan 1800 líneas:
      endSession.md hace rotación segura: sessions_N.yaml, adr_N.yaml.
      Context Agent lee TODOS los archivos rotados hasta detectar >150K tokens.
    impacto: "Sistema escala infinitamente. No se pierden datos nunca."

  - id: "003"
    titulo: "Plan de Contingencia con archivado inteligente (>150K tokens)"
    decision: |
      Cuando total de full/ supera 150K tokens:
      CA mueve ADRs/sessions irrelevantes a memory/history/ (que NO se lee).
      Reduce a ~120K tokens. Datos preservados, recuperables.
    impacto: "Ahorro real de tokens. Sistema escala ilimitadamente."

  - id: "004"
    titulo: "YAML para todo (incluyendo sessions)"
    decision: |
      Todo el sistema usa YAML: sessions.yaml, adr.yaml, project-status.yaml, context.yaml, templates.
    impacto: "Consistencia total. ~30% ahorro tokens vs Markdown."

  - id: "005"
    titulo: "deploy.md como prompt (no script shell)"
    decision: |
      deploy.md que Main-Agent ejecuta con briefing personalizado.
      Más flexible que script automático.
    impacto: "Deployment guiado e inteligente. Personalización según necesidades."

# ============================================
# SESIONES RECIENTES
# Las sesiones más recientes son críticas para entender el estado actual
# ============================================
sesiones_recientes:
  - id: "2025-10-31-preparacion-deployment"
    data: "2025-10-31"
    duracion: "~3h"
    objetivo: "Resolver blockers críticos para deployment, mover viz/, crear history/, reescribir deploy.md con ADR-009"
    highlights:
      - "viz/ movido a raíz (memsys3/viz/) según DEVELOPMENT.md - 8 archivos actualizados"
      - "history/ creado con .gitkeep (templates + dog-fooding) - Plan Contingencia operativo"
      - "deploy.md reescrito completo (206 líneas) con workflow ADR-009 y verificaciones críticas"
      - "Análisis exhaustivo identificó 26 issues: 4 CRÍTICOS + 5 ALTOS + 9 MEDIOS + 8 BAJOS"
      - "Resueltos 9 issues en esta sesión (4 críticos + 5 altos)"
    problemes_resolts:
      - "C1: viewer.js buscaba adrs_filtrades → estandarizado a adrs_incloses (dashboard funcional)"
      - "C2+C3: deploy.md con verificaciones (no sobrescribir memsys3/ existente, limpiar memsys3_temp/)"
      - "C4: viz/README.md con rutas claras 'cd memsys3/viz'"
      - "A6: 6 READMEs actualizados (memory/viz → viz)"
      - "A7: Contradicción líneas vs tokens resuelta (límite: 2000 líneas, no tokens)"
      - "A9: Plan Contingencia informado en briefing de deployment"
    gotchas_documentats:
      - "deploy.md sin verificaciones puede sobrescribir datos al ejecutarse dos veces (ALTA)"
      - "viewer.js buscaba adrs_filtrades pero YAML usa adrs_incloses (ALTA)"
      - "history/ vacío no se sube a git bloqueando Plan Contingencia (.gitkeep necesario) (MITJANA)"

  - id: "2025-10-31-implementacion-adr009"
    data: "2025-10-31"
    duracion: "~2h"
    objetivo: "Implementar ADR-009 completamente y corregir todas las inconsistencias"
    highlights:
      - "Campo gotchas añadido en sessions-template.yaml con estructura: tipus, problema, solucio, criticitat"
      - "Eliminada sección gotchas_i_issues de project-status-template.yaml según ADR-009"
      - "context-agent.yaml actualizado para leer gotchas desde sessions (no project-status)"
      - "deploy.md corregido: eliminada referencia obsoleta gotchas_i_issues (CRÍTICO)"
      - "Corrección rutas: 5 archivos actualizados para usar @memsys3/prompts/"
      - "Estandarización notación: @memsys3/ siempre (notación Claude Code)"
      - "Agente Explore encontró 12 tipos de inconsistencias en 4 categorías"
    problemes_resolts:
      - "deploy.md generaba project-status con campo obsoleto gotchas_i_issues"
      - "Ejemplos en documentación usaban @prompts/ sin prefijo memsys3/"
      - "Inconsistencia notación: 'memsys3/' vs '@memsys3/' estandarizado"
    gotchas_documentats:
      - "deploy.md puede propagar campos obsoletos si no se actualiza con cada ADR (ALTA)"

  - id: "2025-10-31-validacion-deployment"
    data: "2025-10-31"
    duracion: "~3h"
    objetivo: "Validar protocolo de deployment y resolver confusiones sobre templates"
    highlights_sintetizados:
      - "ADR-009 creada (125 líneas): templates permanentes + gotchas en sessions"
      - "docs/DEVELOPMENT.md: nueva sección 'Filosofía: Estructura y Deployment' (+140 líneas)"
      - "Clarificado: ms3t = estructura exacta del producto, memory/templates/ NO se borran"
      - "Rediseño conceptual: memsys3_dev (privado) vs memsys3 (público)"
      - "Workflow deployment: git clone temporal memsys3_temp, copiar, briefing, borrar"

  - id: "2025-10-29-limpieza"
    data: "2025-10-29"
    duracion: "~2h"
    highlights_sintetizados:
      - "Corrección sistemática todas las rutas con prefijo @memsys3/"
      - "Eliminación residuos: 6543 líneas duplicadas"
      - "Validación compilación context.yaml exitosa (556 líneas, v1.2)"
      - "Tag v0.3.0 creado"

  - id: "2025-10-29"
    data: "2025-10-29"
    duracion: "~3-4h"
    highlights_sintetizados:
      - "3 ADRs críticas: 006 (rutas), 007 (READMEs), 008 (workflow)"
      - "4 niveles documentación establecidos"
      - "Restricción Main-Agent: NO proponer compile-context"
      - "Tag v0.2.1 + 5 commits adicionales"

  - id: "2025-10-28"
    data: "2025-10-28"
    duracion: "~8h"
    highlights_sintetizados:
      - "Creación inicial memsys3 v1.0"
      - "Context Agent con criterio inteligente, Plan Contingencia, Rotación automática"
      - "Visualizador Web Memory: 4 pestañas, js-yaml, Python server"
      - "Publicado a GitHub (21 archivos, 3056 línies)"

# ============================================
# GOTCHAS CRÍTICS
# Extrets de sessions.yaml segons criteri del CA
# Ordenats per criticitat + recència
# ============================================
gotchas:
  - id: "deploy_sobrescritura"
    tipo: "warning"
    problema: "deploy.md sin verificaciones puede sobrescribir memsys3/ existente causando pérdida de datos"
    solucion: "Verificar si memsys3/ existe antes de mkdir. Limpiar memsys3_temp/ si existe de ejecución previa"
    criticidad: "alta"
    sesion: "2025-10-31-preparacion-deployment"

  - id: "viewer_nomenclatura"
    tipo: "error"
    problema: "viewer.js buscaba adrs_filtrades pero YAML usa adrs_incloses"
    solucion: "Estandarizar nomenclatura en ambos archivos. Elegir adrs_incloses por ser más claro"
    criticidad: "alta"
    sesion: "2025-10-31-preparacion-deployment"

  - id: "deploy_campos_obsoletos"
    tipo: "warning"
    problema: "deploy.md puede propagar campos obsoletos si no se actualiza con cada ADR"
    solucion: "Revisar deploy.md cuando se creen ADRs que modifiquen estructura de templates"
    criticidad: "alta"
    sesion: "2025-10-31-implementacion-adr009"

  - id: "history_gitkeep"
    tipo: "warning"
    problema: "history/ vacío no se sube a git bloqueando Plan Contingencia en otros clones"
    solucion: "Crear .gitkeep en directorios vacíos que deben existir en git"
    criticidad: "media"
    sesion: "2025-10-31-preparacion-deployment"

  - id: "read_tool_limit"
    tipo: "warning"
    problema: "Read tool tiene límite de 2000 línies - sessions.yaml o adr.yaml pueden créixer infinitament"
    solucion: "Sistema de rotación automática >1800 líneas (sessions_N.yaml, adr_N.yaml)"
    criticidad: "alta"
    sesion: "2025-10-28"
    nota: "Resuelto con ADR-002, pero documentado como gotcha fundamental"

# ============================================
# PENDENTS PRIORITARIS
# ============================================
pendientes:
  - prioritat: 1
    tasca: "Probar deployment completo en proyecto UOC"
    detall: "Ejecutar deployment en proyecto Ciencia de Datos usando nuevo protocolo (clone temporal, briefing, borrar). Validar que todas las correcciones funcionan"

  - prioritat: 2
    tasca: "Migrar repos: memsys3_dev (privado) vs memsys3 (público)"
    detall: "Separar desarrollo interno de distribución pública según decisión ADR-009"

  - prioritat: 3
    tasca: "Resolver 17 issues MEDIOS/BAJOS identificados"
    detall: "Del análisis exhaustivo quedan 17 issues por resolver (9 medios + 8 bajos) - deuda técnica controlada"

  - prioritat: 4
    tasca: "Validar rotación automática en proyecto real"
    detall: "Comprobar que funciona cuando sessions.yaml supera 1800 líneas"

  - prioritat: 5
    tasca: "Validar Plan Contingencia (>150K tokens)"
    detall: "Simular proyecto grande, verificar archivado a history/"

# ============================================
# DECISIONS CLAU DEL PROJECTE
# ============================================
decisions_clau:
  filosofia: "Criterio inteligente del CA, NO límites arbitrarios"
  escalabilitat: "Rotación + archivado automático"
  preservacio: "Dades SEMPRE preservades (history/, sessions_N.yaml, adr_N.yaml)"
  rutas: "Sistema unificado @memsys3/ para portabilidad y claridad (notación Claude Code)"
  documentacion: "Meta-niveles separados según audiencia"
  workflow: "Main-Agent NO compila, solo sugiere endSession"
  templates: "memory/templates/ son guías permanentes, NO se borran post-deployment"
  gotchas: "Se documentan en sessions.yaml (contextualizados), NO en project-status"
  deployment: "Clone temporal memsys3_temp, copiar, briefing con templates, borrar temp"
  limites: "Límite ÚNICO 2000 líneas (no tokens estimados)"
  visualizador: "Ubicado en memsys3/viz/ (raíz, no memory/viz/)"

# ============================================
# NOTES DE COMPILACIÓ DEL CA
# ============================================
notas_compilacion:
  adrs_totals: 9
  adrs_incluidas: 9
  justificacion_adrs: |
    Todas las ADRs son críticas para entender el sistema. Sin cambios desde última compilación.

  sesiones_totales: 7
  sesiones_incluidas: 6
  justificacion_sesiones: |
    - 2025-10-31-preparacion-deployment: MÁS RECIENTE, máximo detalle (26 issues, 9 resueltos)
    - 2025-10-31-implementacion-adr009: Reciente, implementación ADR-009 completa
    - 2025-10-31-validacion-deployment: Sintetizada (ya estaba en v1.4)
    - 2025-10-29-limpieza: Sintetizada más (reducir detalles)
    - 2025-10-29: Sintetizada más (reducir detalles)
    - 2025-10-28: Sintetizada (histórico inicial)

  gotchas_extraidos: 5
  justificacion_gotchas: |
    Extrets de sessions.yaml con estructura correcta (tipus, criticitat).
    Ordenats per criticitat + recència:
    - 3 ALTOS (deploy_sobrescritura, viewer_nomenclatura, deploy_campos_obsoletos)
    - 1 MEDIO (history_gitkeep)
    - 1 ALTO histórico (read_tool_limit - ADR-002 pero gotcha fundamental)

  tokens_iniciales: "~92K tokens (muy por debajo de 150K)"
  tokens_finales: "~3.5K tokens (estimado del context.yaml generado)"

  archivamiento: "NO requerido - volumen manejable"

  criterios_filtraje: |
    - Todas las 9 ADRs incluidas (sin cambios)
    - Sessions: Priorizar 2 más recientes con máximo detalle, sintetizar resto
    - Gotchas: Ahora extraídos con estructura correcta de sessions (CRÍTICO: 3 nuevos gotchas documentados en últimas sessions)
    - Pendientes: actualizados según project-status (prioridad 1: testing deployment UOC)
    - Filosofía: mantener decisiones_clau actualizadas con nuevos estándares

  lineas_totales: "~512 líneas de 2000 máximo (26% del límite)"

  observaciones: |
    Sistema preparado para deployment real después de 3 sesiones intensas el 2025-10-31.

    Sesión preparacion-deployment fue CRÍTICA:
    - Análisis exhaustivo identificó 26 issues clasificados
    - Resueltos 9 issues críticos/altos (prevención pérdida datos, funcionalidad rota)
    - viz/ movido a raíz según DEVELOPMENT.md
    - history/ creado con .gitkeep (Plan Contingencia operativo)
    - deploy.md reescrito completo 206 líneas

    Sistema ahora tiene:
    - Protección contra pérdida de datos en deployment
    - Estructura física correcta (viz/, history/)
    - Visualizador funcional (nomenclatura corregida)
    - Límites claros: 2000 líneas (no tokens)
    - Gotchas documentados con estructura correcta (tipus, criticitat)
    - deploy.md con verificaciones críticas (C2, C3)

    Quedan 17 issues MEDIOS/BAJOS como deuda técnica controlada.

# ============================================
# NOTAS DE USO
# ============================================
# Este archivo es COMPILADO automáticamente, no editar manualmente
# Para actualizar: ejecutar @memsys3/prompts/compile-context.md
# Para más detalles: ver memsys3/memory/full/adr.yaml i memsys3/memory/full/sessions.yaml
# Si context demasiado grande: CA moverá datos a memsys3/memory/history/ (no leído)
